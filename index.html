<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weather Station ‚Äî Pro Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
html{height:100%}
:root{
  --bg1:#04000c;
  --bg2:#1a0437;
  --card:#0a1a24;
  --accent:#00e4ff;
  --text:#ffffff;
}
.light{
  --bg1:#f1f4ff;
  --bg2:#ffffff;
  --card:#ffffff;
  --accent:#005eff;
  --text:#111;
}
body{
  margin:0;
  font-family:Segoe UI,Roboto,sans-serif;
  background:radial-gradient(circle at top,var(--bg2),var(--bg1));
  color:var(--text);
}
header{
  text-align:center;
  padding:20px;
  font-size:32px;
  font-weight:900;
}
.controls{text-align:center;margin-bottom:16px}
button{
  background:var(--accent);
  border:none;
  padding:10px 18px;
  border-radius:14px;
  margin:6px;
  font-weight:700;
  cursor:pointer;
  box-shadow:0 0 18px #00e4ff66;
}
.grid{
  display:grid;
  grid-template-columns:300px 1fr 320px;
  gap:28px;
  padding:24px;
}
.card{
  background:linear-gradient(145deg,#081821,#0c2a3a);
  border-radius:22px;
  padding:18px;
  box-shadow:0 0 35px #0008;
}
.card h3{
  margin:0 0 10px;
  color:var(--accent);
}
.value{
  font-size:36px;
  font-weight:900;
}

/* SENSOR ERROR */
.card.sensor-error{
  background:linear-gradient(145deg,#3a0b0b,#5c1111);
  box-shadow:0 0 35px #ff3b3baa;
}

/* LEFT */
.left{display:flex;flex-direction:column;gap:22px}
.left .card{min-height:110px}

/* CENTER */
.chart-card{height:620px}
canvas{width:100%!important;height:94%!important}

/* RIGHT */
.right{display:flex;flex-direction:column;gap:22px}

/* AQI COLORS */
.aqi-good{color:#7dff9a}
.aqi-moderate{color:#ffd166}
.aqi-bad{color:#ff4d6d}
.aqi-verybad{color:#ff1a1a}

/* ========================= */
/* üîÆ NEON PRESSURE GAUGE */
/* ========================= */
.gauge-wrap{
  position:relative;
  width:260px;
  height:260px;
  margin:auto;
}

.gauge svg{
  width:100%;
  height:100%;
  transform:rotate(-90deg);
}

/* Glass background */
.gauge-glass{
  position:absolute;
  inset:22px;
  border-radius:50%;
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(14px);
  box-shadow:
    inset 0 0 25px rgba(255,255,255,0.12),
    inset 0 0 60px rgba(0,228,255,0.12);
}

/* background ring */
.ring-bg{
  fill:none;
  stroke:#062b36;
  stroke-width:26;
  opacity:0.55;
}

/* animated neon ring */
.ring-fg{
  fill:none;
  stroke:url(#pressureGradient);
  stroke-width:26;
  stroke-linecap:round;
  stroke-dasharray:565;
  stroke-dashoffset:565;
  transition:
    stroke-dashoffset .8s cubic-bezier(.4,0,.2,1),
    filter .6s;
  filter:
    drop-shadow(0 0 18px currentColor)
    drop-shadow(0 0 40px currentColor);
  animation:pulse 3s infinite ease-in-out;
}

@keyframes pulse{
  0%,100%{filter:drop-shadow(0 0 20px currentColor)}
  50%{filter:drop-shadow(0 0 55px currentColor)}
}

/* center text */
.gauge-center{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
}

.gauge-center .big{
  font-size:34px;
  font-weight:900;
  background:linear-gradient(180deg,#ffffff,#9befff);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  text-shadow:
    0 0 12px currentColor,
    0 0 25px currentColor;
}

.gauge-center .sub{
  font-size:13px;
  font-weight:700;
  opacity:.85;
  letter-spacing:1px;
}

/* WEATHER */
.weather{
  font-size:30px;
  font-weight:900;
  text-align:center;
}

/* TOAST */
#toast{
  position:fixed;
  bottom:24px;
  right:24px;
  background:linear-gradient(145deg,#0c2c3d,#0f5c78);
  padding:14px 22px;
  border-radius:18px;
  font-weight:800;
  box-shadow:0 0 30px #00e4ffaa;
  display:none;
}
</style>
</head>

<body>
<header>Weather Station ‚Äî Pro Dashboard</header>

<div class="controls">
  <button onclick="connect()">üîå Connect Arduino</button>
  <button onclick="simulate()">‚ö° Simulate Data</button>
  <button onclick="exportCSV()">üì§ Export CSV</button>
  <button onclick="clearData()">üóë Clear Data</button>
  <button onclick="toggleMode()">üåì Dark/Light Mode</button>
</div>

<div class="grid">

  <!-- LEFT -->
  <div class="left">
    <div class="card" id="tempCard"><h3>üå°Ô∏è Temperature</h3><div class="value" id="temp">-- ¬∞C</div></div>
    <div class="card" id="humCard"><h3>üíß Humidity</h3><div class="value" id="hum">-- %</div></div>
    <div class="card" id="altCard"><h3>üóª Altitude</h3><div class="value" id="alt">-- m</div></div>
    <div class="card" id="rainCard"><h3>üåßÔ∏è Rain</h3><div class="value" id="rain">--</div></div>
  </div>

  <!-- CENTER -->
  <div class="card chart-card">
    <h3>üìä Sensor Graphs</h3>
    <canvas id="chart"></canvas>
  </div>

  <!-- RIGHT -->
  <div class="right">

    <div class="card" id="aqiCard">
      <h3>ü´Å AQI</h3>
      <div class="value" id="aqiVal">--</div>
      <div id="aqiText">--</div>
    </div>

    <div class="card" id="pressCard">
      <h3>üîÆ Atmospheric Pressure</h3>

      <div class="gauge-wrap gauge">
        <svg viewBox="0 0 200 200">
          <defs>
            <linearGradient id="pressureGradient" gradientUnits="userSpaceOnUse" x1="0" y1="0" x2="200" y2="200">
              <stop offset="0%" stop-color="#4da6ff"/>
              <stop offset="50%" stop-color="#00e4ff"/>
              <stop offset="100%" stop-color="#b44cff"/>
            </linearGradient>
          </defs>
          <circle cx="100" cy="100" r="90" class="ring-bg"/>
          <circle cx="100" cy="100" r="90" class="ring-fg" id="ring"/>
        </svg>

        <div class="gauge-glass"></div>

        <div class="gauge-center">
          <div class="big" id="press">-- hPa</div>
          <div class="sub">Atmospheric Pressure</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>üå¶Ô∏è Weather Condition</h3>
      <div class="weather" id="weather">--</div>
    </div>

  </div>
</div>

<div id="toast"></div>

<script>
let chart;
const ctx=document.getElementById("chart");
const rainEl=document.getElementById("rain");
const rainCard=document.getElementById("rainCard");
let lastPressure=null;

/* CHART */
chart=new Chart(ctx,{
  type:"line",
  data:{labels:[],datasets:[
    {label:"Temp",borderColor:"#00e4ff",data:[]},
    {label:"Humidity",borderColor:"#ff4d9a",data:[]},
    {label:"Pressure",borderColor:"#ffd166",data:[]},
    {label:"AQI",borderColor:"#7df2a6",data:[]}
  ]},
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{legend:{labels:{color:"#aaa"}}},
    scales:{x:{ticks:{color:"#666"}},y:{ticks:{color:"#666"}}}
  }
});

function toast(msg){
  const t=document.getElementById("toast");
  t.innerText=msg;
  t.style.display="block";
  setTimeout(()=>t.style.display="none",3000);
}

function setSensor(cardId, elId, val, unit=""){
  const card=document.getElementById(cardId);
  const el=document.getElementById(elId);
  if(val===-1||val===null||isNaN(val)){
    el.innerText="Sensor Missing";
    card.classList.add("sensor-error");
    return null;
  }
  el.innerText=val+unit;
  card.classList.remove("sensor-error");
  return val;
}

/* PARSE DATA LINE */
function parseLine(line){
  const p=line.trim().split(",");
  if(p.length<8)return;
  updateUI(+p[0],+p[1],+p[2],+p[3],+p[4],p[5],+p[7]);
}

/* UPDATE UI */
function updateUI(dhtT,dhtH,bmpT,p,alt,rainStatus,aqi){
  const tempVal=setSensor("tempCard","temp",dhtT," ¬∞C");
  const humVal=setSensor("humCard","hum",dhtH," %");
  setSensor("altCard","alt",alt," m");

  if(!rainStatus||rainStatus==="-1"){
    rainEl.innerText="Sensor Missing";
    rainCard.classList.add("sensor-error");
  }else{
    rainEl.innerText=rainStatus;
    rainCard.classList.remove("sensor-error");
  }

  const presVal=setSensor("pressCard","press",p," hPa");
  if(presVal!==null){
    const percent=Math.min(1,Math.max(0,(presVal-900)/200));
    ring.style.strokeDashoffset=565*(1-percent);
    if(lastPressure!==null){
      ring.style.color = presVal>lastPressure ? "#b44cff" : "#4da6ff";
    }
    lastPressure=presVal;
  }

  /* AQI */
  const aqiVal=setSensor("aqiCard","aqiVal",aqi,"");
  const aqiText=document.getElementById("aqiText");
  if(aqiVal!==null){
    if(aqiVal<=50){ aqiText.innerText="Good"; aqiText.className="aqi-good"; }
    else if(aqiVal<=100){ aqiText.innerText="Moderate"; aqiText.className="aqi-moderate"; }
    else if(aqiVal<=200){ aqiText.innerText="Bad"; aqiText.className="aqi-bad"; }
    else{ aqiText.innerText="Very Bad"; aqiText.className="aqi-verybad"; }
  }

  /* WEATHER CONDITION LOGIC */
  let weatherStr = "";
  const rainLower = (rainStatus || "").trim().toLowerCase();
  if(rainLower === "raining üåßÔ∏è") weatherStr = "üåßÔ∏è Rainy";
  else if(humVal >= 80 && tempVal >= 25) weatherStr = "üå¶Ô∏è Humid/Showers";
  else if(humVal >= 70) weatherStr = "‚òÅÔ∏è Cloudy";
  else if(tempVal >= 30) weatherStr = "üî• Hot";
  else if(tempVal <= 10) weatherStr = "‚ùÑÔ∏è Cold";
  else if(aqiVal >= 200) weatherStr = "‚ò†Ô∏è Hazardous";
  else if(aqiVal >= 100) weatherStr = "üå´Ô∏è Polluted";
  else weatherStr = "‚òÄÔ∏è Clear";

  document.getElementById("weather").innerText = weatherStr;

  chart.data.labels.push("");
  chart.data.datasets[0].data.push(tempVal);
  chart.data.datasets[1].data.push(humVal);
  chart.data.datasets[2].data.push(presVal);
  chart.data.datasets[3].data.push(aqiVal);
  if(chart.data.labels.length>40){
    chart.data.labels.shift();
    chart.data.datasets.forEach(d=>d.data.shift());
  }
  chart.update();
}

/* CSV EXPORT */
function exportCSV(){
  const headers = ["Temp (¬∞C)","Humidity (%)","Pressure (hPa)","AQI"];
  let csv = headers.join(",") + "\n";
  const len = chart.data.labels.length;
  for(let i=0;i<len;i++){
    const row=[
      chart.data.datasets[0].data[i]??"",
      chart.data.datasets[1].data[i]??"",
      chart.data.datasets[2].data[i]??"",
      chart.data.datasets[3].data[i]??""
    ];
    csv += row.join(",") + "\n";
  }
  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "weather_data.csv";
  a.click();
  URL.revokeObjectURL(url);
  toast("üóÉÔ∏è CSV exported");
}

/* SERIAL + PHYSICAL AUTO-RECONNECT */
let port, reader, keepReading=false;

async function connect(){
  try{
    port = await navigator.serial.requestPort();
    await openPort();
  }catch(err){
    toast("‚ö†Ô∏è Connection Failed");
    console.error(err);
  }
}

async function openPort(){
  try{
    await port.open({baudRate:9600});
    toast("‚úÖ Arduino Connected");
    keepReading=true;
    readLoop();
  }catch(err){
    console.error(err);
    toast("‚ö†Ô∏è Failed to open port, retrying...");
    setTimeout(openPort,3000);
  }
}

async function readLoop(){
  try{
    const decoder=new TextDecoderStream();
    port.readable.pipeTo(decoder.writable);
    reader = decoder.readable.getReader();
    let buffer="";
    while(keepReading){
      const {value,done}=await reader.read();
      if(done) break;
      buffer+=value;
      const lines=buffer.split("\n");
      buffer=lines.pop();
      lines.forEach(parseLine);
    }
  }catch(err){
    console.error("Serial disconnected", err);
    toast("‚ö†Ô∏è Arduino disconnected");
    keepReading=false;
  }
}

/* Detect physical connect/disconnect */
navigator.serial.addEventListener('connect', e=>{
  toast("üîå Arduino physically connected");
  if(!port) port = e.target;
  if(port && !keepReading) openPort();
});

navigator.serial.addEventListener('disconnect', e=>{
  toast("‚ùå Arduino physically disconnected");
  if(e.target===port){
    keepReading=false;
    port=null;
  }
});

/* SIMULATION & UTILS */
function simulate(){
  const temp = Math.floor(Math.random()*35) + 5;       // 5¬∞C to 40¬∞C
  const hum = Math.floor(Math.random()*60) + 30;       // 30% to 90%
  const pres = Math.floor(Math.random()*120) + 950;    // 950 to 1070 hPa
  const alt = Math.floor(Math.random()*200);           // 0 to 200 m
  const rain = Math.random() < 0.3 ? "Raining" : "No Rain"; // 30% chance rain
  const aqi = Math.floor(Math.random()*300);           // 0 to 300 AQI
  parseLine(`${temp},${hum},${temp},${pres},${alt},${rain},${aqi},${aqi}`);
}

function clearData(){chart.data.labels=[];chart.data.datasets.forEach(d=>d.data=[]);chart.update()}
function toggleMode(){document.body.classList.toggle("light")}
</script>

</body>
</html>
